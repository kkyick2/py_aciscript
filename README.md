# Cisco APIC Data Extraction and Analysis

## Overview

This project provides a Python script (`pyapicapi.py`) to interact with Cisco APIC (Application Policy Infrastructure Controller) APIs, retrieve data, and export it to Excel files. It supports configurable data extraction based on JSON configuration files and includes optional analysis and contract parsing features through additional modules (`pyapicanaylsis_interface` and `pyapicanaylsis_contract`).

## Features

- **API Interaction**: Authenticates with APIC to retrieve data using provided credentials.
- **Configurable Data Extraction**: Uses a consolidated JSON configuration file (`all_apic_example.json`) for device information and a separate `apic_tables.json` for table definitions.
- **Data Processing**: Converts JSON responses to pandas DataFrames and exports them to Excel.
- **Logging**: Configurable logging for development and production environments.
- **Command-Line Interface**: Supports input file specification and analysis flags via command-line arguments.
- **Modular Design**: Integrates with analysis modules for extended functionality.
- **Concurrent Processing**: Uses ThreadPoolExecutor for parallel processing of multiple devices and analysis tasks.

## Prerequisites

- Python 3.6+
- Required Python packages:
  - `pandas`
  - `requests`
  - `argparse`
  - `logging`
  - `json`
  - `ipaddress`
  - `re`
  - `datetime`
  - `pathlib`
  - `concurrent.futures`
- Cisco APIC access with valid credentials.
- Configuration files in JSON format located in the `config` directory.
- (Optional) `pyapicanaylsis_interface` and `pyapicanaylsis_contract` modules for analysis features.

## Installation

1. Clone the repository or copy the script files to your local machine.
2. Install dependencies:
   ```bash
   pip install pandas requests ipaddress
   ```
3. Ensure the `config`, `log`, and `src` directories exist as shown in the directory structure.
4. Place the consolidated APIC configuration file (`all_apic_example.json`) and table definitions (`apic_tables.json`) in the `config` directory.

## Directory Structure

```plaintext
py_aciscript/
│
├── config/
│   ├── logging.dev.json
│   ├── logging.prod.json
│   ├── all_apic_example.json
│   ├── apic_tables.json
├── log/
│   └── (generated log files)
├── src/
│   ├── pyapicapi.py
│   ├── pyapicanaylsis_interface.py
│   ├── pyapicanaylsis_contract.py
└── README.md
```

## Usage

### pyapicapi.py

Get Cisco APIC information using REST API.

```sh
usage: pyapicapi.py [-h] [-i INFILES] [-a]

options:
  -h, --help            show this help message and exit
  -i INFILES, --infiles INFILES
                        input json in config folder, example: -i all_apic_example.json
  -a, --anaylsis        flag to analysis and parse table to new excel
```

1. Prepare `all_apic_example.json` and `apic_tables.json` in the `config` folder.
2. **Option 1: Interactive File Selection**
   ```sh
   python src/pyapicapi.py
   ```
   - The script lists available JSON config files in the `config` directory and prompts the user to select one.
3. **Option 2: Specify Input File via Command Line**
   ```sh
   python src/pyapicapi.py -i all_apic_example.json -a
   ```
   - `-i` or `--infiles`: Specify the consolidated JSON config file (e.g., `all_apic_example.json`).
   - `-a` or `--anaylsis`: Enables additional analysis and contract parsing.

### pyapicanaylsis_contract.py, pyapicanaylsis_interface.py

Analyze tables generated by `pyapicapi.py`.

```sh
usage: pyapicanaylsis_interface.py [-h] [-i INFILES]

options:
  -h, --help            show this help message and exit
  -i INFILES, --infiles INFILES
                        input excel from pyapicapi.py, example: -i apic_n1_20240101.xlsx
```

- These scripts process Excel files generated by `pyapicapi.py` for further analysis or contract parsing.
- Ensure the input Excel files are available in the `py_aciscript` root directory.

### Configuration File Format

The consolidated JSON configuration file (`all_apic_example.json`) must follow this structure:

```json
{
  "devices": [
    {
      "environment": "n1",
      "ip": "172.31.1.1:443",
      "username": "admin",
      "password": "pass",
      "tables": "apic_tables.json"
    },
    {
      "environment": "n2",
      "ip": "172.31.2.1:443",
      "username": "admin",
      "password": "pass",
      "tables": "apic_tables.json"
    }
  ]
}
```

The table definitions file (`apic_tables.json`) must follow this structure:

```json
{
  "remove_properties_flag": 1,
  "tables": [
    {
      "name": "Loading APIC Topology",
      "key": "topSystem",
      "alias": "Topology",
      "remove_properties": ["oobMgmtGateway", "configIssues"]
    }
  ]
}
```

- `devices`: An array of device configurations, each containing `environment`, `ip`, `username`, `password`, and `tables` (referencing the table definitions file).
- `tables`: List of tables to extract, including the API key, alias, and properties to remove.
- `remove_properties_flag`: Controls whether specified properties are removed from the output.

### Output

- **Excel Files**: Generated in the `py_aciscript` root directory with names like `apic_n1_YYYYMMDD_HHMM.xlsx` for each device environment.
- **Log Files**: Generated in the `log` directory with names like `pyapicapi_YYYYMMDD_HHMMSS.log`.

## Logging

- Logging is configured via `logging.dev.json` or `logging.prod.json` in the `config` directory.
- The environment (`LOG_ENV`) defaults to `dev` but can be set to `prod` for production logging.
- Logs are written to the `log` directory with timestamps.
